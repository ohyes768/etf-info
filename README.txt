# ETF数据分析工具集

## 项目简介

这是一个专门用于分析ETF（交易型开放式指数基金）数据的Python工具集，提供ETF历史数据分析、PB（市净率）计算、持仓分析等功能。项目通过多种数据源获取ETF和股票的历史数据，并进行专业的财务分析。

## 主要功能

### 1. ETF历史数据分析 (`etf_info_cal.py`)
- **功能**：分析指定ETF的历史价格数据和交易指标
- **主要特性**：
  - 支持从阿里云API获取ETF历史数据或从本地CSV文件读取
  - 计算近一年和近60日的最大振幅分析
  - 日均成交额统计
  - 涨跌情况分析和日内波动幅度计算
- **数据源**：阿里云市场API
- **输出**：控制台分析报告

### 2. ETF持仓数据分析 (`etf_details.py`)
- **功能**：获取ETF的持仓明细数据
- **主要特性**：
  - 支持多年份（2020-2025）持仓数据获取
  - 批量处理多个ETF代码
  - 自动创建数据目录结构
  - CSV格式数据存储
- **数据源**：AKShare接口
- **输出**：CSV文件（存储在etf-codes目录）

### 3. ETF PB时间序列分析 (`etf_season_cal.py`)
- **功能**：基于持仓数据计算ETF的PB时间序列
- **主要特性**：
  - 按季度分析ETF持仓变化
  - 自动补充缺失季度数据
  - 计算加权平均PB值
  - 生成PB时间序列图表
  - 分位数分析（20%、80%分位线）
- **数据源**：本地持仓CSV文件 + 数据库PB数据
- **输出**：matplotlib图表展示

### 4. 股票PB计算系统 (`stock_pbcal.py` + `database.py`)
- **功能**：计算和存储个股的PB数据
- **主要特性**：
  - 从网络获取股票价格和净资产数据
  - 计算每日PB值
  - SQLite数据库存储（5年历史数据）
  - 数据缓存机制，避免重复请求
- **数据源**：AKShare接口、同花顺数据
- **输出**：SQLite数据库文件

## 项目结构

```
etf-info/
├── etf_info_cal.py          # ETF历史数据分析工具
├── etf_details.py           # ETF持仓数据获取工具
├── etf_season_cal.py        # ETF PB时间序列分析工具
├── etf_pb_store.py          # ETF PB数据存储工具
├── stock_pbcal.py           # 个股PB计算工具
├── database.py              # 数据库操作模块
├── stock_code_utils.py      # 股票代码处理工具
├── stock_data.db            # SQLite数据库文件
├── etf-codes/               # ETF数据目录
│   ├── his_*.csv           # ETF历史数据文件
│   └── hold_*.csv          # ETF持仓数据文件
├── .env                     # 环境配置文件
├── requiresment.txt         # Python依赖包
└── README.txt              # 项目说明文档
```

## 环境要求

- Python 3.7+
- 主要依赖包：
  - pandas：数据处理
  - numpy：数值计算
  - matplotlib：图表绘制
  - scipy：统计分析
  - akshare：金融数据接口
  - requests：HTTP请求
  - python-dotenv：环境变量管理

## 安装配置

### 1. 克隆项目
```bash
git clone <repository-url>
cd etf-info
```

### 2. 创建虚拟环境
```bash
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows
```

### 3. 安装依赖
```bash
pip install -r requiresment.txt
```

### 4. 配置环境变量
创建 `.env` 文件并配置：
```
ALIYUN_APPCODE=your_aliyun_appcode
```

## 使用方法

### 1. ETF历史数据分析
```bash
python etf_info_cal.py
```
运行后按提示输入ETF代码（如588200），或直接回车使用默认代码。

### 2. 获取ETF持仓数据
```bash
python etf_details.py
```
支持单个代码或多个代码（用逗号分隔）批量处理。

### 3. ETF PB时间序列分析
```bash
python etf_season_cal.py
```
需要确保已通过 `etf_details.py` 获取持仓数据。

### 4. 个股PB数据计算
```bash
python stock_pbcal.py
```
计算结果存储在SQLite数据库中。

## 数据说明

### 数据字段解释

#### ETF历史数据字段
- `D`: 日期
- `O`: 开盘价
- `H`: 最高价
- `L`: 最低价
- `C`: 收盘价
- `V`: 成交量
- `A`: 成交额

#### 持仓数据字段
- `股票代码`: 6位股票代码
- `股票名称`: 股票中文名称
- `占净值比例`: 持仓比例（百分比）
- `季度`: 报告季度

### 数据更新机制
- ETF历史数据：优先读取本地CSV，不存在时从网络获取
- 股票PB数据：优先读取数据库，不存在时从网络获取并存储
- 持仓数据：通过AKShare接口获取最新数据

## 注意事项

1. **API限制**：阿里云API有调用频率限制，请合理使用
2. **数据时效性**：金融数据存在延迟，建议定期更新
3. **网络依赖**：首次运行需要网络连接获取数据
4. **存储空间**：SQLite数据库会随着时间增长，注意清理过期数据

## 输出示例

### ETF分析报告示例
```
=== 近一年数据分析 ===
数据时间范围: 2023-12-04 至 2024-12-04

近一年日最大振幅:
日期: 2024-08-15
振幅: 4.82%
开盘价: 3.85
最高价: 3.92
最低价: 3.75
收盘价: 3.78
当日下跌: 1.82% (开盘价3.85 -> 收盘价3.78)

近一年日均成交额: 15.23亿元

=== 近60日数据分析 ===
近60日最大振幅: 4.82% (日期: 2024-08-15)
去除最大振幅日后的近60日平均日振幅: 1.95%
```

### PB分析图表
- 显示ETF PB时间序列曲线
- 标注20%和80%分位线
- 显示当前PB值及百分位排名
- 支持中文字体显示

## 开发说明

### 扩展功能
1. 添加更多技术指标分析
2. 支持更多ETF类型
3. 增加数据导出功能
4. 添加Web界面

### 数据源扩展
- 可添加更多数据源（如东方财富、新浪财经等）
- 支持国际ETF数据
- 实时数据推送

## 许可证

本项目仅供学习和研究使用，请遵守相关数据提供商的使用条款。

## 联系方式

如有问题或建议，请通过GitHub Issues联系。